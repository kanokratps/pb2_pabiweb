(function(){var h=YAHOO.util.Dom,b=YAHOO.util.KeyListener;var e=Alfresco.util.encodeHTML;Alfresco.HtmlUpload=function(o){Alfresco.HtmlUpload.superclass.constructor.call(this,"Alfresco.HtmlUpload",o,["button","container"]);this.defaultShowConfig={siteId:null,containerId:null,destination:null,uploadDirectory:null,updateNodeRef:null,updateFilename:null,updateVersion:"1.0",mode:this.MODE_SINGLE_UPLOAD,onFileUploadComplete:null,overwrite:false,thumbnails:null,uploadURL:null,username:null,suppressRefreshEvent:false,adobeFlashEnabled:true,maximumFileSize:0};this.showConfig={};return this};YAHOO.extend(Alfresco.HtmlUpload,Alfresco.component.Base,{MODE_SINGLE_UPLOAD:1,MODE_SINGLE_UPDATE:2,defaultShowConfig:null,showConfig:null,versionSection:null,_fileName:null,_fileSize:null,_maximumFileSizeLimit:0,setMaximumFileSizeLimit:function c(o){this._maximumFileSizeLimit=o},getMaximumFileSizeLimit:function f(){return this._maximumFileSizeLimit},onReady:function n(){var q=this;h.removeClass(this.id+"-dialog","hidden");this.widgets.panel=Alfresco.util.createYUIPanel(this.id+"-dialog");var w=document.getElementsByName("frm_"+this.id+"-dialog");var p=h.get(this.id+"-bd1");var t=h.get(this.id+"-fs");var v;if(p){v=p.removeChild(t)}this.formEl=w[0];if(this.formEl){this.formEl.setAttribute("method","POST");this.formEl.appendChild(v)}this.widgets.titleText=h.get(this.id+"-title-span");this.widgets.singleUploadTip=h.get(this.id+"-singleUploadTip-span");this.widgets.singleUpdateTip=h.get(this.id+"-singleUpdateTip-span");this.widgets.filedata=h.get(this.id+"-filedata-file");this.widgets.filedata.contentEditable=false;this.widgets.siteId=h.get(this.id+"-siteId-hidden");this.widgets.containerId=h.get(this.id+"-containerId-hidden");this.widgets.destination=h.get(this.id+"-destination-hidden");this.widgets.username=h.get(this.id+"-username-hidden");this.widgets.updateNodeRef=h.get(this.id+"-updateNodeRef-hidden");this.widgets.uploadDirectory=h.get(this.id+"-uploadDirectory-hidden");this.widgets.overwrite=h.get(this.id+"-overwrite-hidden");this.widgets.thumbnails=h.get(this.id+"-thumbnails-hidden");this.widgets.description=h.get(this.id+"-description-textarea");this.widgets.minorVersion=h.get(this.id+"-minorVersion-radioButton");this.widgets.versionSection=h.get(this.id+"-versionSection-div");this.widgets.uploadButton=Alfresco.util.createYUIButton(this,"upload-button",this.onUploadButtonClick,{type:"submit"});this.widgets.cancelButton=Alfresco.util.createYUIButton(this,"cancel-button",this.onCancelButtonClick);var A=document.getElementById(this.id+"-upload-button-button");var r=document.createElement("input");r.innerHTML=A.innerHTML;r.setAttribute("type","submit");r.setAttribute("tabindex",A.getAttribute("tabindex"));A.parentNode.replaceChild(r,A);r.setAttribute("id",this.id+"-upload-button-button");var o=new Alfresco.forms.Form("frm_"+this.id+"-dialog");this.widgets.form=o;YAHOO.util.Event.addListener(this.id+"-filedata-file","change",function(){if(this.files&&this.files.length>0){q._fileName=this.files[0].name;q._fileSize=this.files[0].size}});o.addValidation(this.id+"-filedata-file",Alfresco.forms.validation.mandatory,null,"change",this.msg("Alfresco.forms.validation.mandatory.message"));if(YAHOO.env.ua.ie==0&&false){o.addValidation(this.id+"-filedata-file",function u(x,s){return !YAHOO.lang.isString(q._fileName)||Alfresco.forms.validation.nodeName({id:x.id,value:q._fileName},s)},null,"change",this.msg("message.illegalCharacters"));o.addValidation(this.id+"-filedata-file",function y(x,s){return s.maximumFileSizeLimit==0||!YAHOO.lang.isNumber(q._fileSize)||q._fileSize<=s.maximumFileSizeLimit},{maximumFileSizeLimit:this._maximumFileSizeLimit},"change",this.msg("message.maxFileFileSizeExceeded"));o.addValidation(this.id+"-filedata-file",function z(x,s){return !YAHOO.lang.isNumber(q._fileSize)||q._fileSize>0},null,"change",this.msg("message.zeroByteFileSelected"))}o.setSubmitElements(this.widgets.uploadButton);o.doBeforeFormSubmit={fn:function(){this.widgets.cancelButton.set("disabled",true);this.widgets.panel.hide();this.widgets.feedbackMessage=Alfresco.util.PopupManager.displayMessage({text:Alfresco.util.message("message.uploading",this.name),spanClass:"wait",displayTime:0,effect:null})},obj:null,scope:this};o.setAJAXSubmit(true,[this.submitHandler]);o.applyTabFix();o.init();this.widgets.escapeListener=new b(document,{keys:b.KEY.ESCAPE},{fn:this.onCancelButtonClick,scope:this,correctScope:true})},submitHandler:function(){alert("submitHandler()")},show:function m(o){this.showConfig=YAHOO.lang.merge(this.defaultShowConfig,o);if(this.showConfig.uploadDirectory===undefined&&this.showConfig.updateNodeRef===undefined){throw new Error("An updateNodeRef OR uploadDirectory must be provided")}if(this.showConfig.uploadDirectory!==null&&this.showConfig.uploadDirectory.length===0){this.showConfig.uploadDirectory="/"}this.widgets.escapeListener.enable();this._showPanel()},hide:function i(){this.onCancelButtonClick()},onUploadSuccess:function g(o){this.widgets.feedbackMessage.hide();var r=o.fileName?o.fileName:this.widgets.filedata.value;if(!this.showConfig.suppressRefreshEvent){YAHOO.Bubbling.fire("metadataRefresh",{currentPath:this.showConfig.path,highlightFile:r})}var p={successful:[{nodeRef:o.nodeRef,fileName:r,response:o}]};var q=this.showConfig.onFileUploadComplete;if(q&&typeof q.fn=="function"){q.fn.call((typeof q.scope=="object"?q.scope:this),p,q.obj)}},onUploadFailure:function k(p){this.widgets.feedbackMessage.hide();var o="message.failure."+p.status.code,q=Alfresco.util.message(o,this.name);if(q==o){q=p.status.code?p.status.code:Alfresco.util.message("message.failure",this.name)}Alfresco.util.PopupManager.displayPrompt({title:Alfresco.util.message("message.failure",this.name),text:q})},onCancelButtonClick:function d(){this.widgets.escapeListener.disable();this.widgets.panel.hide()},onUploadButtonClick:function l(){this.widgets.escapeListener.disable();var o=this.widgets.form;YUI().use("node-event-simulate",function(q){var p=q.one("#frm_"+this.id+"-dialog");p.simulate("submit",{})})},_applyConfig:function a(){var t;if(this.showConfig.mode===this.MODE_SINGLE_UPLOAD){t=Alfresco.util.message("header.singleUpload",this.name)}else{if(this.showConfig.mode===this.MODE_SINGLE_UPDATE){t=Alfresco.util.message("header.singleUpdate",this.name)}}this.widgets.titleText.innerHTML=t;if(this.showConfig.mode===this.MODE_SINGLE_UPDATE){var r=Alfresco.util.message("label.singleUpdateTip",this.name,{"0":this.showConfig.updateFilename});this.widgets.singleUpdateTip.innerHTML=r;h.removeClass(this.widgets.versionSection,"hidden");var p=(this.showConfig.updateVersion||"1.0").split("."),o=parseInt(p[0],10),s=parseInt(p[1],10);h.get(this.id+"-minorVersion").innerHTML=this.msg("label.minorVersion.more",o+"."+(1+s));h.get(this.id+"-majorVersion").innerHTML=this.msg("label.majorVersion.more",(1+o)+".0")}else{h.addClass(this.widgets.versionSection,"hidden")}if(this.showConfig.mode===this.MODE_SINGLE_UPDATE){h.removeClass(this.widgets.singleUpdateTip,"hidden");h.addClass(this.widgets.singleUploadTip,"hidden")}else{h.addClass(this.widgets.singleUploadTip,"hidden");if(this.showConfig.adobeFlashEnabled){h.removeClass(this.widgets.singleUploadTip,"hidden")}h.addClass(this.widgets.singleUpdateTip,"hidden")}this.widgets.cancelButton.set("disabled",false);this.widgets.filedata.value=null;var q=this.formEl;if(this.showConfig.uploadURL===null){q.action=Alfresco.constants.PROXY_URI+"api/upload"}else{q.action=Alfresco.constants.PROXY_URI+this.showConfig.uploadURL}q.action+=";jsessionid="+YAHOO.util.Cookie.get("JSESSIONID")+"?lang="+Alfresco.constants.JS_LOCALE;if(Alfresco.util.CSRFPolicy.isFilterEnabled()){q.action+="&"+Alfresco.util.CSRFPolicy.getParameter()+"="+encodeURIComponent(Alfresco.util.CSRFPolicy.getToken())}this.widgets.siteId.value=this.showConfig.siteId;this.widgets.containerId.value=this.showConfig.containerId;this.widgets.destination.value=this.showConfig.destination;this.widgets.username.value=this.showConfig.username;if(this.showConfig.mode===this.MODE_SINGLE_UPDATE){this.widgets.updateNodeRef.value=this.showConfig.updateNodeRef;this.widgets.uploadDirectory.value="";this.widgets.overwrite.value="";this.widgets.thumbnails.value=""}else{this.widgets.updateNodeRef.value="";this.widgets.uploadDirectory.value=this.showConfig.uploadDirectory;this.widgets.overwrite.value=this.showConfig.overwrite;this.widgets.thumbnails.value=this.showConfig.thumbnails}},_showPanel:function j(){this.widgets.description.value="";this.widgets.minorVersion.checked=true;this._applyConfig();this.widgets.panel.show()}})})();(function(){var f=YAHOO.util.Dom,d=YAHOO.util.KeyListener;var e=Alfresco.util.encodeHTML;Alfresco.ExtUpload=function(k){Alfresco.ExtUpload.superclass.constructor.call(this,"Alfresco.ExtUpload",k,["button","container"]);this.defaultShowConfig={siteId:null,containerId:null,destination:null,uploadDirectory:null,updateNodeRef:null,updateFilename:null,updateVersion:"1.0",mode:this.MODE_SINGLE_UPLOAD,onFileUploadComplete:null,overwrite:false,thumbnails:null,uploadURL:null,username:null,suppressRefreshEvent:false,adobeFlashEnabled:true,maximumFileSize:0};this.showConfig={};return this};YAHOO.extend(Alfresco.ExtUpload,Alfresco.component.Base,{MODE_SINGLE_UPLOAD:1,MODE_SINGLE_UPDATE:2,MODE_MULTI_UPLOAD:3,defaultShowConfig:null,showConfig:null,versionSection:null,_fileName:null,_fileSize:null,_maximumFileSizeLimit:0,onReady:function b(){var k=this;f.removeClass(this.id+"-dialog","hidden");this.widgets.panel=Alfresco.util.createYUIPanel(this.id+"-dialog");this.widgets.titleText=f.get(this.id+"-title-span");this.widgets.singleUploadTip=f.get(this.id+"-singleUploadTip-span");this.widgets.singleUpdateTip=f.get(this.id+"-singleUpdateTip-span");this.widgets.uploadButton=Alfresco.util.createYUIButton(this,"upload-button",this.onUploadButtonClick);this.widgets.cancelButton=Alfresco.util.createYUIButton(this,"cancel-button",this.onCancelButtonClick);this.widgets.escapeListener=new d(document,{keys:d.KEY.ESCAPE},{fn:this.onCancelButtonClick,scope:this,correctScope:true})},show:function j(k){this.showConfig=YAHOO.lang.merge(this.defaultShowConfig,k);if(this.showConfig.uploadDirectory===undefined&&this.showConfig.updateNodeRef===undefined){throw new Error("An updateNodeRef OR uploadDirectory must be provided")}if(this.showConfig.uploadDirectory!==null&&this.showConfig.uploadDirectory.length===0){this.showConfig.uploadDirectory="/"}this.widgets.escapeListener.enable();this._showPanel()},hide:function g(){this.onCancelButtonClick()},onCancelButtonClick:function i(){this.widgets.escapeListener.disable();this.widgets.panel.hide()},_applyConfig:function a(){var k;if(this.showConfig.mode===this.MODE_SINGLE_UPLOAD){k=Alfresco.util.message("header.singleUpload",this.name)}else{if(this.showConfig.mode===this.MODE_SINGLE_UPDATE){k=Alfresco.util.message("header.singleUpdate",this.name)}else{if(this.showConfig.mode===this.MODE_MULTI_UPLOAD){k=this.msg("header.multiUpload")}}}this.widgets.titleText.innerHTML=k;if(this.showConfig.mode===this.MODE_SINGLE_UPDATE){f.removeClass(this.widgets.singleUpdateTip,"hidden");f.addClass(this.widgets.singleUploadTip,"hidden")}else{f.addClass(this.widgets.singleUploadTip,"hidden");if(this.showConfig.adobeFlashEnabled){f.removeClass(this.widgets.singleUploadTip,"hidden")}f.addClass(this.widgets.singleUpdateTip,"hidden")}this.widgets.cancelButton.set("disabled",false)},_showPanel:function h(){this._applyConfig();this.widgets.panel.show();if(!this.uploadPanel){this.uploadPanel=Ext.widget("form",{renderTo:this.id+"-file",border:0,width:468,height:40,dockedItems:[{xtype:"toolbar",dock:"top",height:39,items:[{xtype:"multifilefield",name:"filedata",msgTarget:"side",buttonConfig:{text:"Browse",iconCls:"icon_search"},width:590}]}]})}else{var k=this.uploadPanel.down("multifilefield");k.fileInputEl.dom.value="";k.setValue("");k.setRawValue("")}},onUploadButtonClick:function c(){var m=this;if(m.uploadPanel.down("[name=filedata]").getValue()==""){return}this.widgets.escapeListener.disable();var n=Alfresco.constants.PROXY_URI+"api/upload";n+=";jsessionid="+YAHOO.util.Cookie.get("JSESSIONID")+"?lang="+Alfresco.constants.JS_LOCALE;if(Alfresco.util.CSRFPolicy.isFilterEnabled()){n+="&"+Alfresco.util.CSRFPolicy.getParameter()+"="+encodeURIComponent(Alfresco.util.CSRFPolicy.getToken())}var l=m.uploadPanel.down("[name=filedata]").fileInputEl.dom;for(var k=0;k<l.files.length;k++){this.uploadSingleFile(l.files[k],k,n)}this.widgets.panel.hide()},uploadSingleFile:function(m,l,q){console.log("uploadSingleFile("+l+")");var n=this;var k=l;var p=new XMLHttpRequest();p.addEventListener("load",function(t){var u=JSON.parse(t.target.responseText);n.uploadPanel.down("[name=filedata]").fileInputEl.set({multiple:true,style:"border:0;position:absolute;cursor:pointer;top:-2px;right:-2px;opacity:0;"});var r=[];var s={};s.uploadData='{"description":"","displayPath":"displayPath","isContainer":false,"creator":"","modified":"","modifier":"","fileName":"'+u.fileName+'","nodeRef":"'+u.nodeRef+'","selectable":"","type":"cm:content"}';r.push(s);YAHOO.Bubbling.fire("uploadFinished",{eventGroup:n.mainScope,uploadData:s.uploadData})},false);p.addEventListener("error",function(r){console.log(event.target.responseText)},false);p.open("POST",q);var o=new FormData();o.append("filedata",m);o.append("overwrite",false);o.append("thumbnails","doclib");o.append("contentType","cm:content");o.append("Upload","Submit Query");o.append("destination",this.showConfig.destination);p.send(o)},a:function(){var k=this.uploadPanel.getForm();k.submit({method:"POST",url:action,waitMsg:"Uploading file...",failure:function(m,p){me.uploadPanel.down("[name=filedata]").fileInputEl.set({multiple:true,style:"border:0;position:absolute;cursor:pointer;top:-2px;right:-2px;opacity:0;"});var l=[];var n={};n.uploadData='{"description":"","displayPath":"displayPath","isContainer":false,"creator":"","modified":"","modifier":"","fileName":"'+p.result.fileName+'","nodeRef":"'+p.result.nodeRef+'","selectable":"","type":"cm:content"}';l.push(n);l.push(n);YAHOO.Bubbling.fire("uploadFinished",{eventGroup:me.mainScope,uploadData:n.uploadData})}})}})})();